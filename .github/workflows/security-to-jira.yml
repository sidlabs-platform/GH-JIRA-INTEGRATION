name: GitHub Security to Jira Integration

# Triggers when code scanning alerts are generated on pull requests
on:
  pull_request:
    types: [opened, synchronize, reopened]
  # Triggered when code scanning completes
  code_scanning_alert:
    types: [created, reopened]

permissions:
  # Minimum required permissions following least-privilege principle
  pull-requests: read      # Read PR details and description
  contents: read           # Read repository contents and commits
  security-events: read    # Read security alerts from GitHub Advanced Security

jobs:
  create-jira-issues:
    name: Create Jira Issues for Security Alerts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to access commit messages
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci
        
      - name: Create Jira Issues for Code Scanning Alerts
        env:
          # GitHub context
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_PR_DESCRIPTION: ${{ github.event.pull_request.body }}
          GITHUB_PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          
          # Jira credentials (stored in GitHub Secrets)
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          
          # Jira configuration
          JIRA_DEFAULT_PROJECT: ${{ secrets.JIRA_DEFAULT_PROJECT }}
          JIRA_DEFAULT_ISSUE_TYPE: ${{ secrets.JIRA_DEFAULT_ISSUE_TYPE || 'Task' }}
          JIRA_FALLBACK_LABEL: ${{ vars.JIRA_FALLBACK_LABEL || 'missing-user-story' }}
          JIRA_SECURITY_LABEL: ${{ vars.JIRA_SECURITY_LABEL || 'github-security-alert' }}
          
        run: node ./scripts/create-jira-issues.js
        working-directory: .
